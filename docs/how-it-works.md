# How restty works end-to-end

This is the runtime flow used by the current playground and library components.

## 1) Build and boot

- `bun run build:assets` builds browser bundles into `playground/public/`:
  - `text-shaper.js`
  - `restty-input.js`
  - `restty-wasm.js`
  - `playground.js` (static playground entry for `playground/public/index.html`)
- `bun run playground` starts the dev server.
- `bun run pty` starts a websocket PTY server (`ws://localhost:8787/pty`) that spawns a local shell.

## 2) App initialization

- `playground/app.ts` orchestrates panes and creates terminal apps using internals from `src/app/`.
- Package users initialize via `new Restty({ root })` from `src/index.ts`.
- The app loads WASM via `loadResttyWasm()` (`src/wasm/runtime.ts`), which instantiates the embedded base64 module from `src/wasm/embedded.ts`.
- A terminal instance is created with `restty_create(cols, rows, maxScrollback)`.

## 3) Output path (PTY -> WASM -> GPU)

1. PTY data arrives over websocket (`src/pty/pty.ts`).
2. The input/output filter path processes terminal responses and mouse/clipboard/window-op sequences (`src/input/`).
3. Sanitized text is written into WASM via `ResttyWasm.write(...)`.
4. `restty_render_update` refreshes render buffers.
5. `ResttyWasm.getRenderState(...)` exposes typed-array views (codepoints, colors, graphemes, links, selection, cursor).
6. The renderer builds batches/atlas data and draws through:
   - WebGPU primary path, or
   - WebGL2 fallback path.

## 4) Input path (browser -> PTY/WASM)

1. Keyboard/mouse/IME events are captured by the app layer (`ResttyApp` internals).
2. `createInputHandler(...)` encodes keys and mouse protocol sequences (`src/input/keymap.ts`, `src/input/mouse.ts`).
3. If PTY is connected, encoded input is sent to websocket server (`sendPtyInput`).
4. If PTY is not connected, text can still be written directly to WASM for local demos/harness behavior.

## 5) Terminal responses back to PTY

- Some escape-sequence responses are generated by the WASM stream handler (for example DSR/DA responses).
- `ResttyWasm.drainOutput(...)` reads that output and forwards it back through websocket when PTY is connected.

## 6) Theme and rendering state

- Built-in themes are generated from `assets/themes/` into `src/theme/builtin-themes.ts` via `bun run build:themes`.
- Theme colors are applied in the app layer and forwarded to WASM default/palette color APIs when available.
